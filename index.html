<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Giftly Gifts ‚Äî Roulette + TON Wallet</title>

  <!-- Libs -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/Draggable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
  <script src="https://unpkg.com/embla-carousel/embla-carousel.umd.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

  <style>
    :root{
      --bg:#0d1117;
      --panel:#161b22;
      --soft:#1c1c1e;
      --line:#2e2e2e;
      --text:#ffffff;
      --muted:#9aa3b2;
      --blue:#2ea1f8;
      --blue-2:#5e9fff;
      --shadow:0 16px 40px rgba(0,0,0,.45);
      --rad:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* Loader */
    #loader{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#121212;z-index:9999}
    .spinner{border:4px solid rgba(255,255,255,.1);border-top:4px solid var(--blue);border-radius:50%;width:42px;height:42px;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    #app{display:none}

    /* Top bar */
    .top-bar{
      position:sticky; top:0; z-index:20; display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:var(--panel); border-bottom:1px solid #202634; padding:8px 12px;
    }
    .profile{display:flex;align-items:center;gap:10px}
    .profile img{width:36px;height:36px;border-radius:50%;border:2px solid #2a3240}
    .profile span{font-weight:800}

    /* Wallet pill */
    .wallet{display:flex;align-items:center;gap:8px}
    .connect-btn{
      display:inline-flex;align-items:center;gap:8px;background:linear-gradient(90deg,#36bfff,#5e9fff);
      color:#fff;border:0;border-radius:14px;padding:10px 14px;font-weight:900;cursor:pointer;box-shadow:0 10px 28px rgba(46,161,248,.28);
    }
    .pill{
      display:none;align-items:center;gap:8px;background:#0f1420;border:1px solid #26324b;padding:8px 12px;border-radius:14px;box-shadow:var(--shadow)
    }
    .pill.show{display:inline-flex}
    .pill .val{font-weight:900;letter-spacing:.2px}
    .pill .plus{width:26px;height:26px;display:grid;place-items:center;border-radius:10px;background:#1a263b;border:1px solid #2e3b57;color:#dfeaff;font-weight:900;cursor:pointer}
    .caret{width:18px;height:18px;opacity:.9;cursor:pointer;transition:.2s}
    .caret.rot{transform:rotate(180deg)}
    .menu{
      position:absolute;right:12px;top:58px;background:#0e1219;border:1px solid #232b3f;border-radius:12px;padding:8px;min-width:220px;display:none;z-index:25;box-shadow:var(--shadow)
    }
    .menu.open{display:block}
    .menu .row{color:#cfe0ff;font-family:ui-monospace,Menlo,Consolas,monospace;margin:6px 0}
    .menu button{width:100%;background:transparent;border:0;color:#eaeefc;text-align:left;padding:10px 12px;border-radius:10px;font-weight:800;cursor:pointer}
    .menu button:hover{background:#141a26}

    .container{padding:12px 16px 20px;max-width:640px;margin:0 auto}

    /* Banner */
    .news-banner{
      width:100%;height:56px;background:linear-gradient(90deg,#36bfff,#5e9fff);
      border-radius:15.5px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;
      font-weight:700;margin:12px 0;box-shadow:var(--shadow)
    }
    .news-banner .btn{background:#fff;color:#5e9fff;border:0;border-radius:12px;padding:8px 12px;font-weight:800;cursor:pointer}

    /* Mode selector */
    .mode-selector{display:flex;gap:6px;background:#1c1c1e;border-radius:16px;padding:4px;margin-bottom:10px}
    .mode-option{flex:1;text-align:center;padding:10px 0;border-radius:12px;font-weight:800;cursor:pointer;user-select:none}
    .mode-option.active{background:#2c2c2e}

    /* Reel */
    .reel{position:relative;width:100%;height:130px;overflow:hidden;border-radius:12px;background:rgba(255,255,255,.06);backdrop-filter:blur(6px);margin:12px 0 16px}
    .pointer-line{position:absolute;top:0;left:50%;width:4px;height:100%;background:rgba(0,200,255,.5);transform:translateX(-50%);z-index:10}
    .gifts-wrapper{display:flex;height:100%;align-items:center;will-change:transform}
    .gift{width:100px;height:100px;background:rgba(255,255,255,.08);border-radius:15px;display:flex;align-items:center;justify-content:center;margin:0 10px;flex-shrink:0}
    .gift img{max-width:90px;max-height:90px}

    /* Pay row (TON toggle) */
    .pay-row{display:flex;align-items:center;justify-content:space-between;background:#12161f;border:1px solid #22304a;border-radius:12px;padding:10px 12px;margin-bottom:8px}
    .pay-label{color:#bcd1ff;font-weight:800}
    .switch{position:relative;width:56px;height:30px;border-radius:999px;background:#28344a;border:1px solid #3a4761;cursor:pointer}
    .switch::after{content:'';position:absolute;top:3px;left:3px;width:24px;height:24px;border-radius:50%;background:#fff;transition:.25s}
    .switch.on{background:#34c759;border-color:#2aa34a}
    .switch.on::after{left:29px}

    /* Buttons */
    .btn-primary{width:100%;background:var(--blue);color:#fff;border:0;border-radius:10px;padding:12px 18px;font-weight:900;cursor:pointer}
    .btn-primary:active{transform:translateY(1px)}
    .extra-button{display:block;width:100%;padding:11px 24px;background:transparent;color:#fff;font-size:15px;font-weight:900;text-align:center;text-decoration:none;border:3px solid rgba(255,255,255,.7);border-radius:9px;margin-top:6px}

    /* Embla */
    .swipe-text{font-size:17px;margin:10px 0 12px 4px;font-weight:800}
    .embla{overflow:hidden;width:100%}
    .embla__container{display:flex}
    .embla__slide{flex:0 0 auto;width:70px;height:70px;margin-right:10px;background:rgba(255,255,255,.08);border-radius:10px;display:flex;align-items:center;justify-content:center}
    .embla__slide img{max-width:60px;max-height:60px}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.9);backdrop-filter:blur(45px);display:none;align-items:center;justify-content:center;z-index:60;flex-direction:column}
    .modal-image{max-width:90%;max-height:60%;object-fit:contain;margin-top:-20px;margin-bottom:15px}
    .modal h2{margin:0;color:#00ffcc}
    .modal .close{font-size:16px;margin-top:26px;padding:10px 26px;width:90%}

    /* Wallet Sheet */
    .sheet{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.55);z-index:80}
    .sheet.open{display:flex}
    .sheet-card{width:100%;max-width:640px;background:linear-gradient(180deg,#0e1219,#0b0f16);border-top-left-radius:18px;border-top-right-radius:18px;border:1px solid #232a3b;padding:14px 14px 18px;box-shadow:0 -16px 40px rgba(0,0,0,.45)}
    .sheet-head{display:flex;align-items:center;justify-content:space-between;padding:6px 4px 10px}
    .sheet-title{font-weight:900;font-size:20px}
    .sheet-close{background:transparent;border:0;color:#b8c2d9;font-size:22px;cursor:pointer}
    .tabs{display:flex;gap:8px;padding:6px 2px 12px}
    .tab{flex:1;text-align:center;padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:800;background:#141a26;border:1px solid #242c3e;color:#cfe0ff}
    .tab.active{background:linear-gradient(90deg,#2fa6ff,#1a73ff);color:#fff;border-color:transparent}
    .panel{display:none}
    .panel.active{display:block}
    .row{display:flex;flex-direction:column;gap:6px;padding:8px 2px}
    .input{width:100%;padding:14px 14px;border-radius:12px;border:1px solid #273149;outline:none;background:#0f1420;color:#fff;font-weight:800;font-size:18px}
    .primary{width:100%;margin-top:8px;padding:14px;border-radius:12px;border:0;cursor:pointer;font-weight:900;color:#fff;background:linear-gradient(90deg,#2fa6ff,#1a73ff)}
    .small{font-size:12px;color:#93a2bf}
    .history-list{display:flex;flex-direction:column;gap:18px;max-height:320px;overflow:auto;padding:2px}
    .history-date{font-size:12px;font-weight:800;color:#9aa3b2}
    .history-item{background:#121722;border:1px solid #1f2633;border-radius:14px;padding:12px 14px;display:flex;justify-content:space-between;align-items:center}
    .history-title{font-weight:800}
    .history-time{font-size:12px;color:#8b93a7}
    .amt.plus{color:#4cd964;font-weight:900}
    .amt.minus{color:#ff3b30;font-weight:900}

    /* Toast */
    .toast{position:fixed;left:50%;top:10px;transform:translateX(-50%);width:min(640px,calc(100% - 24px));background:#101624;border:1px solid #2a3550;color:#eaf1ff;padding:12px 14px;border-radius:14px;z-index:100;display:flex;align-items:center;gap:10px;opacity:0;pointer-events:none;box-shadow:var(--shadow)}
    .toast.show{pointer-events:auto}
    .footer-text{font-size:12px;color:#888;text-align:center;margin:5% 0 10px}
  </style>
</head>
<body>
  <!-- Loader -->
  <div id="loader"><div class="spinner"></div></div>

  <div id="app">
    <!-- Top bar -->
    <div class="top-bar">
      <div class="profile">
        <img id="profilePic" src="" alt="Profile">
        <span id="profileName">User</span>
      </div>

      <div class="wallet">
        <button id="connectBtn" class="connect-btn"><span>Connect TON</span></button>
        <div id="pill" class="pill">
          <span class="val" id="balVal">0.00</span> TON
          <div id="plus" class="plus">+</div>
          <svg id="caret" class="caret" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </div>
        <div id="menu" class="menu">
          <div class="row">Connected: <span id="addrShort"></span></div>
          <button id="disconnect">Disconnect</button>
        </div>
      </div>
    </div>

    <div class="container">
      <!-- Banner -->
      <div class="news-banner">
        <span>Turbo Gifts here!</span>
        <button class="btn" onclick="window.location.href='https://t.me/AutoGiftysBot'">Open Gifts</button>
      </div>

      <!-- Modes -->
      <div class="mode-selector" id="modeSelector">
        <div class="mode-option active" data-mode="35" data-price="35" data-ton="0.35" data-link="https://t.me/$zLCg1Xa26UlZDQAA5UvFqNpOjqo">35‚òÖ</div>
        <div class="mode-option" data-mode="50" data-price="50" data-ton="0.65" data-link="https://t.me/$6k1Z8Ha26UlaDQAAVovivYcjdqU">50‚òÖ</div>
        <div class="mode-option" data-mode="150" data-price="150" data-ton="1" data-link="https://t.me/$SR_sP3a26UlbDQAAvm5lKSwJrGg">150‚òÖ</div>
      </div>

      <!-- Pay toggle -->
      <div class="pay-row">
        <div class="pay-label">–û–ø–ª–∞—Ç–∞ –≤ TON</div>
        <div id="paySwitch" class="switch" role="switch" aria-checked="false"></div>
      </div>

      <!-- Reel -->
      <div class="reel" id="reel">
        <div class="pointer-line"></div>
        <div class="gifts-wrapper" id="giftsTrack"></div>
      </div>

      <button id="spinButton" class="btn-primary">Try your luck 35‚òÖ</button>
      <a href="https://t.me/StarsotekaRobot?start=d846ae70" class="extra-button">–ö—É–ø–∏—Ç—å 50‚òÖ –∑–∞ 79‚ÇΩ</a>

      <div class="swipe-text">What can I drop?</div>
      <div class="embla" id="embla"><div class="embla__container" id="emblaTrack"></div></div>
    </div>

    <!-- Modal -->
    <div class="modal" id="modal">
      <img id="modalImage" class="modal-image" src="nothing_drop.png" alt="Prize image" style="display:none">
      <div class="modal-animation" id="modalLottie"></div>
      <h2>Try your luck next time üçÄ</h2>
      <button id="closeModal" class="btn-primary close">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <footer class="footer-text">¬© 2025 All rights reserved</footer>
  </div>

  <!-- Wallet sheet -->
  <div id="sheet" class="sheet" aria-hidden="true">
    <div class="sheet-card">
      <div class="sheet-head">
        <div class="sheet-title">Wallet</div>
        <button id="sheetClose" class="sheet-close">√ó</button>
      </div>
      <div class="tabs">
        <div id="tabDep" class="tab active">Deposit</div>
        <div id="tabHist" class="tab">History</div>
      </div>
      <div id="panelDep" class="panel active">
        <div class="small">Connected: <span id="addrDep">‚Äî</span></div>
        <div class="row">
          <input id="amountInput" class="input" type="number" step="0.01" min="0" placeholder="Amount in TON">
          <button id="depositBtn" class="primary">Deposit</button>
          <div class="small">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏ –æ–ø–ª–∞—Ç—É –≤ Tonkeeper ‚Äî –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å—É–º–º–∞ –∑–∞—á–∏—Å–ª–∏—Ç—Å—è –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –±–∞–ª–∞–Ω—Å.</div>
        </div>
      </div>
      <div id="panelHist" class="panel">
        <div id="historyList" class="history-list"></div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"><span id="toastText">Done</span></div>

<script>
/* ====== CONFIG ====== */
const MERCHANT_ADDRESS = 'UQDyKNQLN_PqZgd_NXnVe80cezX9M5mCL0izNW3w2iQAXkp0'; // ‚Üê –∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π
const MANIFEST_URL = 'https://vocococo.github.io/ton-connect/tonconnect-manifest.json';

const STORAGE_BAL = 'roulette_ton_balance_v1';
const STORAGE_HIST = 'roulette_ton_history_v1';

const modes = {
  '35':  { stars:35,  ton:0.35, link:'https://t.me/$zLCg1Xa26UlZDQAA5UvFqNpOjqo' },
  '50':  { stars:50,  ton:0.65, link:'https://t.me/$6k1Z8Ha26UlaDQAAVovivYcjdqU' },
  '150': { stars:150, ton:1.00, link:'https://t.me/$SR_sP3a26UlbDQAAvm5lKSwJrGg' }
};

/* ====== Helpers ====== */
const $ = s => document.querySelector(s);
function truncate(a){ return a ? a.slice(0,4)+'‚Ä¶'+a.slice(-4) : ''; }
function showToast(t){
  const el = $('#toast'); $('#toastText').textContent = t;
  if (window.gsap){ gsap.killTweensOf(el); gsap.set(el,{opacity:0,y:-14});
    el.classList.add('show');
    gsap.to(el,{opacity:1,y:0,duration:.25,ease:'power2.out'});
    gsap.to(el,{opacity:0,y:-14,delay:1.6,duration:.22,ease:'power2.in',onComplete:()=>el.classList.remove('show')});
  } else { el.style.opacity=1; setTimeout(()=>el.style.opacity=0,1500); }
}
function readBal(){ return Number(localStorage.getItem(STORAGE_BAL) || '0'); }
function writeBal(v){ localStorage.setItem(STORAGE_BAL, String(v)); renderPill(); }
function addHist(rec){ const list = JSON.parse(localStorage.getItem(STORAGE_HIST)||'[]'); list.unshift(rec); localStorage.setItem(STORAGE_HIST, JSON.stringify(list)); }
function getHist(){ try{return JSON.parse(localStorage.getItem(STORAGE_HIST)||'[]');}catch(e){return [];} }

/* ====== TonConnect ====== */
const tonUI = new TON_CONNECT_UI.TonConnectUI({
  manifestUrl: MANIFEST_URL,
  actionsConfiguration: { twaReturnUrl: 'https://t.me' }
});

/* ====== Top bar profile ====== */
function updateProfile(){
  try{
    Telegram.WebApp.ready();
    const u = Telegram.WebApp.initDataUnsafe?.user;
    if(!u) return;
    $('#profileName').textContent = u.first_name || u.username || 'User';
    if(u.photo_url) $('#profilePic').src = u.photo_url;
  }catch(e){}
}

/* ====== Wallet UI ====== */
const connectBtn = $('#connectBtn');
const pill = $('#pill'); const balVal = $('#balVal');
const plus = $('#plus'); const caret = $('#caret'); const menu = $('#menu');
const addrShort = $('#addrShort'); const disconnectBtn = $('#disconnect');

async function renderPill(){
  const bal = readBal();
  balVal.textContent = (bal<1? bal.toFixed(4): bal.toFixed(2));
  const addr = tonUI.account?.address;
  if(addr){ connectBtn.style.display='none'; pill.classList.add('show'); addrShort.textContent = truncate(addr); }
  else { pill.classList.remove('show'); connectBtn.style.display='inline-flex'; }
}
renderPill();

connectBtn.addEventListener('click', async ()=>{ try{ await tonUI.openModal(); }catch{} });
tonUI.onStatusChange(()=> renderPill());

caret.addEventListener('click',(e)=>{
  e.stopPropagation();
  if(menu.classList.contains('open')){
    caret.classList.remove('rot'); menu.classList.remove('open');
  } else {
    caret.classList.add('rot'); menu.classList.add('open');
  }
});
document.addEventListener('click',(e)=>{ if(menu.classList.contains('open') && !menu.contains(e.target) && e.target!==caret){ caret.classList.remove('rot'); menu.classList.remove('open'); }});
disconnectBtn.addEventListener('click', async ()=>{ try{ await tonUI.disconnect(); }catch{}; caret.classList.remove('rot'); menu.classList.remove('open'); renderPill(); });

/* ====== Wallet sheet ====== */
const sheet = $('#sheet'); const sheetClose = $('#sheetClose');
const tabDep = $('#tabDep'); const tabHist = $('#tabHist');
const panelDep = $('#panelDep'); const panelHist = $('#panelHist');
const amountInput = $('#amountInput'); const depositBtn = $('#depositBtn');
const addrDep = $('#addrDep');

function openSheet(which='dep'){
  if(tonUI.connected) addrDep.textContent = truncate(tonUI.account.address);
  sheet.classList.add('open'); sheet.setAttribute('aria-hidden','false');
  setSheetTab(which);
  if(window.gsap){ gsap.fromTo($('.sheet-card'),{y:30,opacity:0},{y:0,opacity:1,duration:.25}); }
}
function closeSheet(){
  if(window.gsap) gsap.to($('.sheet-card'),{y:30,opacity:0,duration:.18,onComplete:()=>{sheet.classList.remove('open'); sheet.setAttribute('aria-hidden','true');}});
  else { sheet.classList.remove('open'); }
}
function setSheetTab(which){
  [tabDep,tabHist].forEach(t=>t.classList.remove('active'));
  [panelDep,panelHist].forEach(p=>p.classList.remove('active'));
  if(which==='dep'){ tabDep.classList.add('active'); panelDep.classList.add('active'); }
  else { tabHist.classList.add('active'); panelHist.classList.add('active'); renderHistory(); }
}
plus.addEventListener('click',()=>{ if(!tonUI.connected){ tonUI.openModal(); return; } openSheet('dep'); });
sheetClose.addEventListener('click', closeSheet);
sheet.addEventListener('click',(e)=>{ if(e.target===sheet) closeSheet(); });
tabDep.addEventListener('click',()=> setSheetTab('dep'));
tabHist.addEventListener('click',()=> setSheetTab('hist'));

/* Deposit flow */
depositBtn.addEventListener('click', async ()=>{
  if(!tonUI.connected){ await tonUI.openModal(); return; }
  const amount = Number(amountInput.value);
  if(!amount || amount<=0){ alert('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É TON'); return; }
  try{
    closeSheet();
    await tonUI.sendTransaction({
      validUntil: Math.floor(Date.now()/1000)+300,
      messages:[{ address: MERCHANT_ADDRESS, amount: String(Math.round(amount*1e9)) }]
    });
    writeBal(readBal() + amount);
    addHist({ type:'deposit', amount, date: Date.now() });
    showToast(`+${amount} TON –∑–∞—á–∏—Å–ª–µ–Ω–æ`);
  }catch(e){
    console.error(e); alert('–ü–ª–∞—Ç—ë–∂ –æ—Ç–º–µ–Ω—ë–Ω');
  }
});

/* History render */
function renderHistory(){
  const list = getHist();
  const wrap = $('#historyList'); wrap.innerHTML='';
  if(!list.length){ wrap.innerHTML='<div style="color:#8b93a7;text-align:center;padding:10px">No transactions yet</div>'; return; }
  const groups = {};
  list.forEach(tx=>{
    const date = new Date(tx.date).toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'}).toUpperCase();
    (groups[date] ||= []).push(tx);
  });
  Object.keys(groups).forEach(date=>{
    const hd=document.createElement('div'); hd.className='history-date'; hd.textContent=date; wrap.appendChild(hd);
    groups[date].forEach(tx=>{
      const row=document.createElement('div'); row.className='history-item';
      const left=document.createElement('div');
      const title=document.createElement('div'); title.className='history-title';
      const time=document.createElement('div'); time.className='history-time'; time.textContent=new Date(tx.date).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
      if(tx.type==='deposit') title.textContent='Deposit';
      else if(tx.type==='spin') title.textContent=`Spin ‚Äî ${tx.mode}‚òÖ`;
      else title.textContent='Operation';
      left.appendChild(title); left.appendChild(time);
      const amt=document.createElement('div'); amt.className='amt '+(tx.type==='deposit'?'plus':'minus');
      amt.textContent=(tx.type==='deposit'?`+${tx.amount} TON`:`-${tx.amount} TON`);
      row.appendChild(left); row.appendChild(amt); wrap.appendChild(row);
    });
  });
}

/* ====== Gifts / Reel ====== */
const gifts = ["1CHzB4K5FantEZu.png","680e5d8f8bf66.png","toTNAm2yurDAiqK.png","U8z9ivaScNyJ86V.png","Oj0IhQW5D5QyVFf.png","PQM9MVSTAF7sQ12.png","nothing_drop.png","pudbsohqxfD98gc.png","bvK9PmcyFgAh4gP.png","q2c0eUx5k8krA97.png"];
const fullGifts=[]; for(let i=0;i<10;i++) fullGifts.push(...gifts);
const giftsTrack = $('#giftsTrack');
fullGifts.forEach(src=>{ const d=document.createElement('div'); d.className='gift'; const img=document.createElement('img'); img.src=src; d.appendChild(img); giftsTrack.appendChild(d); });

/* Embla mini gallery */
const emblaTrack = $('#emblaTrack');
gifts.forEach(src=>{ const s=document.createElement('div'); s.className='embla__slide'; const img=document.createElement('img'); img.src=src; s.appendChild(img); emblaTrack.appendChild(s); });
EmblaCarousel(document.getElementById("embla"),{loop:false,align:"start",dragFree:true});

/* ====== Pay switch + button ====== */
const paySwitch = $('#paySwitch');
let currentMode = '35';  // default
function updateSpinLabel(){
  const m = modes[currentMode];
  if(paySwitch.classList.contains('on')){
    $('#spinButton').textContent = `Try your luck ${m.ton} TON`;
  }else{
    $('#spinButton').textContent = `Try your luck ${m.stars}‚òÖ`;
  }
}
document.querySelectorAll('.mode-option').forEach(opt=>{
  opt.addEventListener('click',()=>{
    document.querySelectorAll('.mode-option').forEach(o=>o.classList.remove('active'));
    opt.classList.add('active');
    currentMode = opt.dataset.mode;
    updateSpinLabel();
  });
});
paySwitch.addEventListener('click',()=>{
  paySwitch.classList.toggle('on');
  paySwitch.setAttribute('aria-checked', paySwitch.classList.contains('on')?'true':'false');
  updateSpinLabel();
});

/* ====== Spin / Payment ====== */
let spinning = false;
const spinButton = $('#spinButton');

function startSpinAnimation(){
  spinning = true;
  const prize = "nothing_drop.png"; // –¥–µ–º–æ
  const idx = fullGifts.findIndex(v=>v===prize) + 5 * gifts.length;
  const offset = idx * 120 - ($('#reel').offsetWidth/2 - 60);
  gsap.to(giftsTrack,{
    x: -offset, duration: 6, ease: "power5.inOut",
    onComplete(){
      $('#modal').style.display='flex';
      $('#modalImage').style.display='none';
      const cont = $('#modalLottie'); cont.innerHTML='';
      lottie.loadAnimation({
        container: cont, renderer:'svg', loop:true, autoplay:true,
        path:'https://lottie.host/2e7b308e-92b6-495c-a96b-cf93e02eb7b4/BiwZQ7vQaf.json'
      });
    }
  });
}

spinButton.addEventListener('click', async ()=>{
  if(spinning) return;
  const m = modes[currentMode];

  // TON mode ‚Üí spend internal balance
  if(paySwitch.classList.contains('on')){
    const bal = readBal();
    if(bal + 1e-9 < m.ton){ showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ TON –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º –±–∞–ª–∞–Ω—Å–µ'); return; }
    writeBal(bal - m.ton);
    addHist({ type:'spin', amount:m.ton, mode:m.stars, date:Date.now() });
    showToast(`-${m.ton} TON —Å–ø–∏—Å–∞–Ω–æ`);
    startSpinAnimation();
    return;
  }

  // Stars mode ‚Üí openInvoice
  Telegram.WebApp.openInvoice(m.link);
});

/* After invoice (Stars) */
Telegram.WebApp.onEvent("invoiceClosed", (ev)=>{
  if(ev.status === "paid"){ startSpinAnimation(); }
});

/* Close modal */
$('#closeModal').addEventListener('click',()=>{
  $('#modal').style.display='none';
  if(window.gsap) gsap.set(giftsTrack,{x:0});
  spinning = false;
});

/* ====== Init ====== */
window.addEventListener('load', ()=>{
  const MIN = 900; const start = Date.now();
  const waitReady = ()=>{
    if(window.Telegram && Telegram.WebApp){
      const elapsed = Date.now()-start, left = Math.max(0, MIN-elapsed);
      setTimeout(()=>{
        Telegram.WebApp.ready();
        $('#loader').style.display='none'; $('#app').style.display='block';
        updateProfile(); updateSpinLabel(); renderPill();
      }, left);
    }else setTimeout(waitReady, 100);
  };
  waitReady();
});
</script>
</body>
</html>
