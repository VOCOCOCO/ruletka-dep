<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no"/>
<title>Voco Gifts ‚Äî Roulette, Tasks, Inventory + TON</title>

<!-- Libs -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/Draggable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.10.2/lottie.min.js"></script>
<script src="https://unpkg.com/embla-carousel/embla-carousel.umd.js"></script>
<script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

<style>
:root{
  --bg:#0d1117;
  --panel:#161b22;
  --soft:#1c1f26;
  --line:#2a2f3a;
  --text:#f5f7ff;
  --muted:#a9b3c9;
  --blue:#2ea1f8;
  --blue2:#5e9fff;
  --ok:#34c759;
  --danger:#ff453a;
  --gold:#FFD14B;
  --radius:16px;
  --shadow:0 14px 40px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--text);
  font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,"SF Pro",Arial,sans-serif;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}

/* Top bar */
.topbar{
  position:sticky; top:0; z-index:30; padding:10px 14px;
  background:linear-gradient(180deg,rgba(13,17,23,.98),rgba(13,17,23,.92) 70%,rgba(13,17,23,0));
  border-bottom:1px solid rgba(255,255,255,.04); backdrop-filter:blur(6px);
  display:flex; align-items:center; justify-content:space-between; gap:10px;
}
.profile{ display:flex; align-items:center; gap:10px; min-width:0; }
.avatar{ width:44px; height:44px; border-radius:50%; background:#222 center/cover; border:2px solid #2b3140; flex-shrink:0; }
.name{ font-weight:800; font-size:18px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

/* Wallet area (connect/balance) */
.wallet-wrap{ display:flex; align-items:center; gap:8px; position:relative; }
.connect-btn{
  display:inline-flex; align-items:center; gap:8px; border:0; cursor:pointer;
  padding:10px 14px; border-radius:14px;
  background:linear-gradient(90deg,#36bfff,#5e9fff);
  color:#fff; font-weight:900; box-shadow:0 8px 22px rgba(32,120,255,.25);
}
.balance-pill{
  display:none; align-items:center; gap:8px; padding:8px 12px; border-radius:14px;
  background:#0f1420; border:1px solid #2a3347; box-shadow:0 8px 22px rgba(0,0,0,.25);
}
.balance-pill.show{ display:inline-flex; }
.ton-icon{ width:18px; height:18px; object-fit:contain; display:block }
.balance-val{ font-weight:900; letter-spacing:.2px; }
.plus-btn{ width:26px; height:26px; display:grid; place-items:center; border-radius:10px; background:#24314b; border:1px solid #34415a; cursor:pointer; font-weight:900; font-size:18px; line-height:1; color:#e8f0ff; }
.wallet-caret{ width:16px; height:16px; opacity:.9; cursor:pointer; transition:.2s; }
.wallet-caret.rot{ transform:rotate(180deg); }
.wallet-menu{
  position:absolute; right:0; top:56px; z-index:55; display:none;
  background:#0f1320; border:1px solid #242c3e; border-radius:12px; padding:8px; min-width:220px;
  box-shadow:0 12px 32px rgba(0,0,0,.5);
}
.wallet-menu.open{ display:block; }
.wallet-menu .row{ display:flex; align-items:center; gap:8px; color:#93a2bf; font-size:12px; margin:4px 0 8px; padding:8px 10px; }
.wallet-menu .hf{ font-family:ui-monospace,SFMono-Regular,Consolas,Menlo,monospace; color:#cfe0ff; }
.wallet-menu button{ width:100%; background:transparent; border:0; color:#eaf1ff; text-align:left; padding:10px 12px; border-radius:10px; font-weight:800; cursor:pointer; }
.wallet-menu button:hover{ background:#141a26; }

/* Tabs bar bottom */
.tabbar{
  position:fixed; left:0; right:0; bottom:0; z-index:60;
  display:flex; justify-content:center; align-items:center; padding:8px 10px;
  background:linear-gradient(0deg,rgba(13,17,23,1),rgba(13,17,23,.96));
  border-top:1px solid rgba(255,255,255,.03);
}
.tabs{ width:min(560px,100%); display:flex; gap:12px; justify-content:center; }
.tab{ width:48px; height:48px; border-radius:14px; background:#111523; border:1px solid #252b3d; display:grid; place-items:center; cursor:pointer; box-shadow:0 10px 20px rgba(0,0,0,.25); transition:.12s; }
.tab img{ width:22px; height:22px; opacity:.9 }
.tab.active{ outline:2px solid #3f69ff55; transform:translateY(-2px); }
.tab.disabled{ opacity:.4; pointer-events:none; }

/* Content wrappers */
.page{ display:none; padding-bottom:82px; }
.page.active{ display:block; }
.container{ padding:10px 14px 18px; max-width:560px; margin:0 auto; }

/* News banner */
.banner{
  width:100%; height:56px; background:linear-gradient(90deg,#36bfff,#5e9fff);
  border-radius:16px; display:flex; align-items:center; justify-content:space-between;
  padding:0 16px; font-weight:800; font-size:16px; margin:6px 0 12px; box-shadow:var(--shadow);
}
.banner .btn{ background:#fff; color:#2ea1f8; border:0; padding:8px 12px; border-radius:12px; font-weight:800; cursor:pointer; }

/* Mode selector */
.mode{ display:flex; gap:6px; background:#1c1c1e; border-radius:16px; padding:4px; margin:10px 0 12px; }
.mode .opt{ flex:1; text-align:center; padding:8px 0; border-radius:12px; color:#fff; font-weight:700; font-size:15px; user-select:none; cursor:pointer; }
.mode .opt.active{ background:#2c2c2e; }

/* TON toggle row */
.payton-row{ display:flex; align-items:center; justify-content:space-between; margin:8px 0 10px; }
.payton-label{ color:#a8b0c3; font-weight:800; }
.switch{ position:relative; width:56px; height:32px; border-radius:999px; background:#233045; border:1px solid #34415a; cursor:pointer; transition:.25s; }
.switch::after{ content:''; position:absolute; top:3px; left:3px; width:26px; height:26px; border-radius:50%; background:#fff; transition:.25s; }
.switch.on{ background:#34C759; border-color:#2aa34a; }
.switch.on::after{ left:27px; }

/* Reel */
.reel{ position:relative; width:100%; height:130px; overflow:hidden; border-radius:12px; background:rgba(255,255,255,.06); backdrop-filter:blur(6px); margin-bottom:12px; }
.gifts-wrapper{ display:flex; height:100%; align-items:center; will-change:transform; }
.gift{ width:100px; height:100px; background:rgba(255,255,255,.08); border-radius:15px; display:flex; justify-content:center; align-items:center; flex-shrink:0; margin:0 10px; }
.gift img{ max-width:90px; max-height:90px;border-radius: 14px; /* üîπ –∑–∞–∫—Ä—É–≥–ª–µ–Ω–∏–µ —É–≥–ª–æ–≤ */ }
.pointer-line{ position:absolute; top:0; left:50%; width:4px; height:100%; background:rgba(0,200,255,.5); transform:translateX(-50%); z-index:10; }

/* Buttons */
.btn-primary{ width:100%; background:var(--blue); color:#fff; border:0; padding:12px 18px; font-size:16px; font-weight:900; border-radius:10px; cursor:pointer; }
.btn-outline{ display:block; width:100%; padding:11px 24px; background:transparent; color:#fff; font-size:15px; font-weight:900; text-align:center; text-decoration:none; border:3px solid rgba(255,255,255,.7); border-radius:10px; margin-top:6px; }

/* Modal result */
.modal{ position:fixed; inset:0; background:rgba(0,0,0,.9); backdrop-filter:blur(40px); display:none; align-items:center; justify-content:center; z-index:80; flex-direction:column; }
.modal.open{ display:flex; }
.modal h2{ font-size:22px; margin:8px 0 0; color:#00ffcc; }
.modal .lottie{ width:240px; height:240px; }
.modal .close{ margin-top:20px; width:90%; }

/* Wallet sheet */
.wallet-overlay{ position:fixed; inset:0; z-index:70; display:none; align-items:flex-end; justify-content:center; background:rgba(8,10,12,.6); backdrop-filter:blur(4px); }
.wallet-overlay.open{ display:flex; }
.wallet-modal{ width:100%; max-width:560px; background:linear-gradient(180deg,#0e1219,#0b0f16); border-top-left-radius:18px; border-top-right-radius:18px; border:1px solid #232a3b; padding:14px 14px 18px; box-shadow: 0 -16px 40px rgba(0,0,0,.45); }
.wallet-header{ display:flex; align-items:center; justify-content:space-between; padding:6px 4px 10px; }
.wallet-title{ font-weight:900; font-size:20px; }
.wallet-close{ background:transparent; border:0; color:#b8c2d9; font-size:22px; cursor:pointer; }
.wallet-tabs{ display:flex; gap:8px; padding:6px 2px 12px; }
.wallet-tab{ flex:1; text-align:center; padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:800; background:#141a26; border:1px solid #242c3e; color:#cfe0ff; transition:.25s; }
.wallet-tab.active{ background:linear-gradient(90deg,#2fa6ff,#1a73ff); color:#fff; border-color:transparent; }
.tab-panel{ display:none; }
.tab-panel.active{ display:block; }
.form-row{ display:flex; flex-direction:column; gap:6px; padding:6px 2px; }
.input-ton{ width:100%; padding:14px 14px; border-radius:12px; border:1px solid #273149; outline:none; background:#0f1420; color:#fff; font-weight:800; font-size:18px; }
.primary-btn{ width:100%; margin-top:8px; padding:14px; border-radius:12px; border:0; cursor:pointer; font-weight:900; color:#fff; background:linear-gradient(90deg,#2fa6ff,#1a73ff); }
.small{ font-size:12px; color:#93a2bf; }
.hf-address{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; color:#cfe0ff; letter-spacing:.2px; }

/* Toast */
.toast{
  position:fixed; left:50%; top:10px; transform:translateX(-50%) translateY(-20px);
  width:min(560px, calc(100% - 24px));
  background:#101624; border:1px solid #2a3550; color:#eaf1ff;
  padding:12px 14px; border-radius:14px; z-index:90; display:flex; align-items:center; gap:10px;
  opacity:0; pointer-events:none; box-shadow:0 16px 38px rgba(0,0,0,.45);
}
.toast.show{ pointer-events:auto; }

/* ----- Tasks page ----- */
.tasks-hero{
  width:100%; aspect-ratio: 16/7; border-radius:18px; overflow:hidden; background:#123; display:grid; place-items:center; margin-bottom:12px; }
.tasks-hero img{ width:100%; height:100%; object-fit:cover; }

.tasks-list{ display:flex; flex-direction:column; gap:10px; }
.task-item {
  background: #121722;
  border: 1px solid #1f2633;
  border-radius: 14px;
  padding: 12px 14px;
  display: flex;
  gap: 12px;
  align-items: center;
  margin-bottom: 10px; /* üîπ –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏ */
}

.task-logo{ width:38px; height:38px; border-radius:10px; background:#1b202c; display:grid; place-items:center; font-size:20px; }
.task-main{ display:flex; flex-direction:column; gap:4px; flex:1; min-width:0; }
.task-title{ font-weight:800; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.task-reward{ color:#ffd14b; font-weight:900; font-size:14px; }
.task-action{ margin-left:auto; }
.badge-done{ background:#0e2a17; color:#69e083; padding:8px 12px; border-radius:10px; font-weight:900; }
.btn-start{ background:#2a2f3b; border:1px solid #3a4354; color:#e8eeff; padding:10px 14px; border-radius:10px; font-weight:900; cursor:pointer; }

/* ----- Inventory ----- */
.inv-profile{ display:flex; flex-direction:column; align-items:center; gap:8px; margin:12px 0; }
.big-avatar{ width:96px; height:96px; border-radius:50%; background:#222 center/cover; border:3px solid #303544; }
.inv-name{ font-weight:900; font-size:20px; }
.inv-empty{ text-align:center; color:#8d95a8; padding:18px 6px; }

.swipe-text {
  font-size: 17px;
  margin-top: 12px;
  margin-bottom: 10px;
  padding-left: 10px;
  font-weight: bold;
}

.embla {
  overflow: hidden;
  width: 100%;
}

.embla__container {
  display: flex;
}

.embla__slide {
  flex: 0 0 auto;
  width: 70px;
  height: 70px;
  margin-right: 10px;
  background: rgba(255,255,255,0.08);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.embla__slide img {
  max-width: 60px;
  max-height: 60px;
  border-radius: 8px; /* üîπ –∑–∞–∫—Ä—É–≥–ª–µ–Ω–∏–µ —É–≥–ª–æ–≤ */
}


</style>
</head>
<body>

<!-- Topbar -->
<div class="topbar">
  <div class="profile">
    <div id="avatar" class="avatar" aria-hidden="true"></div>
    <div class="name" id="userName">User</div>
  </div>

  <div class="wallet-wrap">
    <button id="connectBtn" class="connect-btn"><span class="addr">Connect TON</span></button>

    <div id="balancePill" class="balance-pill" title="Balance">
      <img id="tonIcon" class="ton-icon" src="https://raw.githubusercontent.com/ton-blockchain/wallet-assets/master/ton_symbol.png" alt="TON">
      <span id="balanceValue" class="balance-val">0.00</span>
      <div id="plusBtn" class="plus-btn" role="button">+</div>
      <svg id="walletCaret" class="wallet-caret" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <div id="walletMenu" class="wallet-menu" role="menu" aria-hidden="true">
        <div class="row">Connected:&nbsp;<span id="hfAddr" class="hf">‚Äî</span></div>
        <button id="disconnectBtn">Disconnect TON</button>
      </div>
    </div>
  </div>
</div>

<!-- Pages -->
<main id="page1" class="page active">
  <div class="container">
    <div class="banner">
      <span>Turbo Gifts here!</span>
      <button class="btn" onclick="openLink('https://t.me/AutoGiftysBot')">Open Gifts</button>
    </div>

    <div class="mode" id="modeWrap">
      <div class="opt active" data-price="35" data-link="https://t.me/$7zWPMAlBQUibEgAAxCURt9XSYc0">45‚òÖ</div>
      <div class="opt" data-price="50" data-link="https://t.me/$geukcwlBQUicEgAAi0BsmLkdtjs">99‚òÖ</div>
      <div class="opt" data-price="150" data-link="https://t.me/$8_CV8AlBQUieEgAARcGF66pKL3Y">149‚òÖ</div>
    </div>

    <div class="payton-row">
      <div class="payton-label">–û–ø–ª–∞—Ç–∞ –≤ TON</div>
      <div id="payTon" class="switch" role="switch" aria-checked="false"></div>
    </div>

    <div class="reel" id="reel">
      <div class="pointer-line"></div>
      <div class="gifts-wrapper" id="giftsTrack"></div>
    </div>

    <button id="spinBtn" class="btn-primary">Try your luck 35‚òÖ</button>
    <a href="https://t.me/LuxuryStarsBot/app?startapp=R60mNloJ" class="btn-outline">–ö—É–ø–∏—Ç—å 50+‚òÖ</a>

    <div class="swipe-roulette-container">
  <div class="swipe-text">What can I drop?</div>
  <div class="embla" id="embla">
    <div class="embla__container" id="emblaTrack"></div>
  </div>
</div>

  
</main>

<main id="page2" class="page">
  <div class="container">
    <div class="tasks-hero">
      <!-- –í—Å—Ç–∞–≤—å —Å–≤–æ—ë –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∏–Ω–∏–π –±–∞–Ω–Ω–µ—Ä -->
      <img id="tasksHero" src="IMG_3621.JPEG" alt="Tasks">
    </div>

    <div style="font-weight:900; font-size:18px; margin:6px 2px 12px;">Tasks:</div>
    <div id="tasksList" class="tasks-list"></div>
  </div>
</main>

<main id="page3" class="page">
  <div class="container">
    <div class="inv-profile">
      <div id="bigAvatar" class="big-avatar"></div>
      <div id="bigName" class="inv-name">User</div>
    </div>
    <div id="invEmpty" class="inv-empty">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</div>
    <div id="invGrid"></div>
  </div>
</main>

<!-- Bottom tabbar -->
<nav class="tabbar">
  <div class="tabs">
    <div class="tab active" data-target="page1" title="–ú–∞—Ä–∫–µ—Ç"><img src="https://img.icons8.com/ios-filled/50/FFFFFF/shop.png" alt=""></div>
    <div class="tab" data-target="page2" title="Tasks"><img src="https://img.icons8.com/ios-filled/50/FFFFFF/checkmark.png" alt=""></div>
    <div class="tab" data-target="page3" title="–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å"><img src="https://img.icons8.com/ios-filled/50/FFFFFF/treasure-chest.png" alt=""></div>
  </div>
</nav>

<!-- Result modal -->
<div id="resultModal" class="modal" aria-hidden="true">
  <div id="modalAnim" class="lottie"></div>
  <h2 id="modalTitle">Try your luck next time üçÄ</h2>
  <button class="btn-primary close">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>

<!-- Wallet sheet -->
<div id="walletOverlay" class="wallet-overlay" aria-hidden="true">
  <div class="wallet-modal" role="dialog" aria-modal="true">
    <div class="wallet-header">
      <div class="wallet-title">Wallet</div>
      <button id="walletClose" class="wallet-close" aria-label="Close">√ó</button>
    </div>

    <div class="wallet-tabs">
      <div id="tabDeposit" class="wallet-tab active">Deposit</div>
      <div id="tabHistory" class="wallet-tab">History</div>
    </div>

    <div id="panelDeposit" class="tab-panel active">
      <div class="small">Connected: <span id="connectedShort" class="hf-address">‚Äî</span></div>
      <div class="form-row">
        <input id="amountInput" class="input-ton" type="number" step="0.01" min="0" placeholder="Payment in TON" />
        <button id="depositBtn" class="primary-btn">Deposit</button>
        <div class="small">–ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤ Tonkeeper —Å—Ä–µ–¥—Å—Ç–≤–∞ –∑–∞—á–∏—Å–ª—è—Ç—Å—è –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –±–∞–ª–∞–Ω—Å.</div>
      </div>
    </div>

    <div id="panelHistory" class="tab-panel">
      <div id="historyList" class="tasks-list" style="max-height:300px; overflow:auto;"></div>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast"><img id="toastIcon" style="width:16px;height:16px" alt=""><span id="toastText">‚Äî</span></div>

<script>
/* ========= SETTINGS ========= */
const MERCHANT_ADDRESS = 'UQDyKNQLN_PqZgd_NXnVe80cezX9M5mCL0izNW3w2iQAXkp0'; // –ø–æ–ª—É—á–∞—Ç–µ–ª—å TON
const TONCENTER_API    = 'https://toncenter.com/api/v2';
const TONCENTER_KEY    = '01b2fe1b9a8b20aabb513086419b6dc4ca59209e5411d773037ebd356c44c43c';
const MANIFEST_URL     = 'https://github.com/VOCOCOCO/ruletka-dep/blob/main/tonconnect-manifest.json';

/* –¶–µ–Ω–∞ TON –¥–ª—è —Ä–µ–∂–∏–º–æ–≤ ‚Äî –ø–æ —Ç–≤–æ–µ–º—É –¢–ó (–Ω–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è!) */
const TON_PRICE_BY_STARS = { 35: 0.35, 50: 0.65, 150: 1.00 };

/* LocalStorage keys */
const APP_BALANCE_KEY  = 'voco_ton_balance_v1';
const APP_HISTORY_KEY  = 'voco_ton_history_v1';
const TASKS_STATE_KEY  = 'voco_tasks_state_v1';
const INV_KEY          = 'voco_inventory_v1';

/* ========= UTIL ========= */
const $ = s => document.querySelector(s);
function openLink(url){ if(window.Telegram?.WebApp?.openLink) Telegram.WebApp.openLink(url); else window.open(url,'_blank'); }
function animateIn(el){ if(typeof gsap!=='undefined'&&el){ gsap.fromTo(el,{opacity:0,y:12},{opacity:1,y:0,duration:.28,ease:'power2.out'});} }
function animateOut(el,cb){ if(typeof gsap!=='undefined'&&el){ gsap.to(el,{opacity:0,y:12,duration:.2,ease:'power2.in',onComplete:cb}); } else cb&&cb(); }

/* ========= TOAST ========= */
const toast = $('#toast'), toastIcon = $('#toastIcon'), toastText = $('#toastText');
function showToast(text){
  toastIcon.src = $('#tonIcon')?.src || '';
  toastText.textContent = text;
  gsap.killTweensOf(toast);
  gsap.set(toast,{y:-20,opacity:0});
  toast.classList.add('show');
  gsap.to(toast,{y:0,opacity:1,duration:.28,ease:'power2.out'});
  gsap.to(toast,{y:-20,opacity:0,delay:1.6,duration:.25,ease:'power2.in',onComplete:()=>toast.classList.remove('show')});
}

/* ========= TON CONNECT ========= */
const tonUI = new TON_CONNECT_UI.TonConnectUI({
  manifestUrl: MANIFEST_URL,
  actionsConfiguration: { twaReturnUrl: 'https://t.me' }
});

/* ========= BALANCE / HISTORY ========= */
function readBalance(){ return Number(localStorage.getItem(APP_BALANCE_KEY) || '0'); }
function writeBalance(v){ localStorage.setItem(APP_BALANCE_KEY, String(v)); renderBalancePill(); }
function addHistory(rec){ const list = JSON.parse(localStorage.getItem(APP_HISTORY_KEY)||'[]'); list.unshift(rec); localStorage.setItem(APP_HISTORY_KEY, JSON.stringify(list)); }
function readHistory(){ try{return JSON.parse(localStorage.getItem(APP_HISTORY_KEY)||'[]');}catch(e){return [];} }

const connectBtn   = $('#connectBtn');
const balancePill  = $('#balancePill');
const balanceValue = $('#balanceValue');
const plusBtn      = $('#plusBtn');
const walletCaret  = $('#walletCaret');
const walletMenu   = $('#walletMenu');
const disconnectBtn= $('#disconnectBtn');
const hfAddrSpan   = $('#hfAddr');

async function renderBalancePill(){
  const bal = readBalance();
  balanceValue.textContent = (bal<1 ? bal.toFixed(4) : bal.toFixed(2));
  const addr = tonUI.account?.address;
  if(addr){
    connectBtn.style.display='none';
    balancePill.classList.add('show');
    hfAddrSpan.textContent = addr.slice(0,4)+'‚Ä¶'+addr.slice(-4);
  } else {
    balancePill.classList.remove('show');
    connectBtn.style.display='inline-flex';
  }
}
connectBtn.addEventListener('click', async ()=>{ try{ await tonUI.openModal(); }catch{} });
tonUI.onStatusChange(renderBalancePill);
renderBalancePill();

/* Wallet dropdown */
walletCaret.addEventListener('click', (e)=>{
  e.stopPropagation();
  if(walletMenu.classList.contains('open')){
    walletCaret.classList.remove('rot');
    animateOut(walletMenu, ()=>{
      walletMenu.classList.remove('open');
      walletMenu.setAttribute('aria-hidden','true');
      walletMenu.style.opacity=''; walletMenu.style.transform='';
    });
  } else {
    walletMenu.classList.add('open'); walletMenu.setAttribute('aria-hidden','false'); walletCaret.classList.add('rot');
    gsap.fromTo(walletMenu,{opacity:0,scale:.98,y:-6},{opacity:1,scale:1,y:0,duration:.22,ease:'power2.out'});
  }
});
document.addEventListener('click',(e)=>{
  if(walletMenu.classList.contains('open') && !walletMenu.contains(e.target) && e.target!==walletCaret){
    walletCaret.classList.remove('rot');
    animateOut(walletMenu, ()=>{
      walletMenu.classList.remove('open');
      walletMenu.setAttribute('aria-hidden','true');
      walletMenu.style.opacity=''; walletMenu.style.transform='';
    });
  }
});
disconnectBtn.addEventListener('click', async ()=>{
  try{ await tonUI.disconnect(); }catch{};
  walletCaret.classList.remove('rot');
  walletMenu.classList.remove('open'); walletMenu.setAttribute('aria-hidden','true');
  renderBalancePill();
});

/* ========= Wallet sheet ========= */
const walletOverlay = $('#walletOverlay');
const walletClose = $('#walletClose');
const tabDeposit  = $('#tabDeposit');
const tabHistory  = $('#tabHistory');
const panelDeposit= $('#panelDeposit');
const panelHistory= $('#panelHistory');
const connectedShort = $('#connectedShort');
const amountInput = $('#amountInput');
const depositBtn  = $('#depositBtn');

function setWalletTab(which){
  [tabDeposit,tabHistory].forEach(t=>t.classList.remove('active'));
  [panelDeposit,panelHistory].forEach(p=>p.classList.remove('active'));
  if(which==='deposit'){ tabDeposit.classList.add('active'); panelDeposit.classList.add('active'); }
  else { tabHistory.classList.add('active'); panelHistory.classList.add('active'); renderHistory(); }
}
function openWallet(which='deposit'){
  if(tonUI.connected) connectedShort.textContent = tonUI.account.address.slice(0,4)+'‚Ä¶'+tonUI.account.address.slice(-4);
  walletOverlay.classList.add('open'); walletOverlay.setAttribute('aria-hidden','false');
  animateIn($('.wallet-modal')); setWalletTab(which);
}
function closeWallet(){ animateOut($('.wallet-modal'), ()=>{ walletOverlay.classList.remove('open'); walletOverlay.setAttribute('aria-hidden','true'); }); }
plusBtn.addEventListener('click', ()=>{ if(!tonUI.connected){ tonUI.openModal(); return; } openWallet('deposit'); });
walletClose.addEventListener('click', closeWallet);
walletOverlay.addEventListener('click',(e)=>{ if(e.target===walletOverlay) closeWallet(); });
tabDeposit.addEventListener('click', ()=> setWalletTab('deposit'));
tabHistory.addEventListener('click', ()=> setWalletTab('history'));

depositBtn.addEventListener('click', async ()=>{
  if (!tonUI.connected){ await tonUI.openModal(); return; }
  const amount = Number(amountInput.value);
  if (!amount || amount<=0){ alert('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É TON'); return; }
  const nanoAmount = (amount * 1e9).toFixed(0);
  try{
    closeWallet();
    await tonUI.sendTransaction({
      validUntil: Math.floor(Date.now()/1000) + 300,
      messages: [{ address: MERCHANT_ADDRESS, amount: nanoAmount }]
    });
    writeBalance(readBalance()+amount);
    addHistory({ type:'deposit', amount, date: Date.now() });
    showToast(`+${amount} TON –∑–∞—á–∏—Å–ª–µ–Ω–æ ‚úÖ`);
  }catch(e){
    console.error(e); alert('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞ ‚ùå');
  }
});

function renderHistory(){
  const list = readHistory();
  const holder = $('#historyList'); holder.innerHTML='';
  if(!list.length){ holder.innerHTML = '<div class="inv-empty" style="padding:8px 0;">No transactions yet</div>'; return; }
  list.forEach(tx=>{
    const card = document.createElement('div');
    card.className='task-item';
    const logo = document.createElement('div'); logo.className='task-logo'; logo.textContent = tx.type==='deposit' ? '‚ÇÆ' : '‚òÖ';
    const main = document.createElement('div'); main.className='task-main';
    const title= document.createElement('div'); title.className='task-title';
    const sub  = document.createElement('div'); sub.className='task-reward';
    if(tx.type==='deposit'){ title.textContent='Deposit'; sub.textContent = `+${tx.amount} TON`; sub.style.color='#69e083'; }
    else { title.textContent='Roulette purchase'; sub.textContent = tx.payWith==='ton' ? `-${tx.amount} TON` : `-${tx.amount} ‚òÖ`; sub.style.color = tx.payWith==='ton' ? '#ffdf70' : '#ffdf70'; }
    main.appendChild(title); main.appendChild(sub);
    card.appendChild(logo); card.appendChild(main);
    holder.appendChild(card);
  });
}

/* ========= TABS ========= */
const tabs = document.querySelectorAll('.tab');
tabs.forEach(t=>t.addEventListener('click', ()=>{
  tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active');
  const target = t.getAttribute('data-target'); document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(target).classList.add('active');
  animateIn(document.getElementById(target).querySelector('.container'));
}));

/* ========= TELEGRAM USER ========= */
(function initTelegramUser(){
  try{
    if(window.Telegram && Telegram.WebApp){
      Telegram.WebApp.ready();
      const u = Telegram.WebApp.initDataUnsafe?.user || null;
      if(u){
        const parts=[]; if(u.first_name)parts.push(u.first_name); if(u.last_name)parts.push(u.last_name);
        if(!parts.length && u.username) parts.push(u.username);
        const display = parts.join(' ') || 'User';
        $('#userName').textContent = display; $('#bigName').textContent = display;
        if(u.photo_url){ $('#avatar').style.backgroundImage=`url("${u.photo_url}")`; $('#bigAvatar').style.backgroundImage=`url("${u.photo_url}")`; }
      }
    }
  }catch(e){}
})();

/* ========= REEL DATA ========= */
const gifts = [
  "springbasket-12125.medium.jpg","artisanbrick-5640.medium.jpg","bdaycandle-11298.medium.jpg","berrybox-46461.medium.jpg",
  "easteregg-140331.medium.jpg","gemsignet-5768.medium.jpg","nothing_drop.png",
  "lightsword-105121.medium.jpg","lowrider-19031.medium.jpg","genielamp-3195.medium.jpg"
];
const fullGifts=[]; for(let i=0;i<10;i++) fullGifts.push(...gifts);
const giftsTrack = $('#giftsTrack');
fullGifts.forEach(g=>{ const d=document.createElement('div'); d.className='gift'; const img=document.createElement('img'); img.src=g; d.appendChild(img); giftsTrack.appendChild(d); });

/* ========= EMBLA PREVIEW ========= */
const emblaTrack = $('#emblaTrack');
gifts.forEach(g=>{ const slide=document.createElement('div'); slide.className='embla__slide'; const img=document.createElement('img'); img.src=g; slide.appendChild(img); emblaTrack.appendChild(slide); });
EmblaCarousel(document.getElementById('embla'),{loop:false,align:"start",dragFree:true});

/* ========= MODE + TOGGLE ========= */
const modeWrap = $('#modeWrap');
const payTonSwitch = $('#payTon');
const spinBtn = $('#spinBtn');
let selectedStars = 45;
let selectedInvoice = "https://t.me/$7zWPMAlBQUibEgAAxCURt9XSYc0";

function updateSpinButtonLabel(){
  if(payTonSwitch.classList.contains('on')){
    const ton = TON_PRICE_BY_STARS[selectedStars] || 0;
    spinBtn.innerHTML = `Try your luck ${ton.toFixed(2)} TON`;
  }else{
    spinBtn.textContent = `Try your luck ${selectedStars}‚òÖ`;
  }
}
modeWrap.querySelectorAll('.opt').forEach(opt=>{
  opt.addEventListener('click', ()=>{
    modeWrap.querySelectorAll('.opt').forEach(o=>o.classList.remove('active'));
    opt.classList.add('active');
    selectedStars = Number(opt.getAttribute('data-price'));
    selectedInvoice = opt.getAttribute('data-link');
    updateSpinButtonLabel();
  });
});
payTonSwitch.addEventListener('click', ()=>{
  payTonSwitch.classList.toggle('on');
  payTonSwitch.setAttribute('aria-checked', payTonSwitch.classList.contains('on') ? 'true' : 'false');
  updateSpinButtonLabel();
});
updateSpinButtonLabel();

/* ========= RESULT MODAL ========= */
const resultModal = $('#resultModal');
const modalAnim = $('#modalAnim');
const modalTitle = $('#modalTitle');
resultModal.querySelector('.close').addEventListener('click', ()=> resultModal.classList.remove('open'));
function openResult(ok=true){
  resultModal.classList.add('open');
  modalTitle.textContent = ok ? '–£—Ä–∞! –ü–æ–¥–∞—Ä–æ–∫ –±–ª–∏–∑–∫–æ ‚ú®' : 'Try your luck next time üçÄ';
  modalAnim.innerHTML='';
  lottie.loadAnimation({
    container: modalAnim,
    renderer: 'svg', loop: true, autoplay: true,
    path: ok
      ? 'https://lottie.host/1c3d0b1a-2e9e-4f60-b0d8-2f0b2d74a3e3/8pZQqK2s3y.json'
      : 'https://lottie.host/2e7b308e-92b6-495c-a96b-cf93e02eb7b4/BiwZQ7vQaf.json'
  });
}

/* ========= INVENTORY (–≤–∏–∑—É–∞–ª—å–Ω–æ) ========= */
function readInv(){ try{return JSON.parse(localStorage.getItem(INV_KEY)||'[]');}catch(e){return [];} }
function saveInv(v){ localStorage.setItem(INV_KEY, JSON.stringify(v)); }
function addInvItem(title){ const list=readInv(); list.unshift({title, ts:Date.now()}); saveInv(list); renderInv(); }
function renderInv(){
  const list=readInv(); const g=$('#invGrid'); const empty=$('#invEmpty');
  g.innerHTML=''; if(!list.length){ empty.style.display='block'; return; }
  empty.style.display='none';
  list.forEach(it=>{
    const card=document.createElement('div');
    card.className='task-item';
    const logo=document.createElement('div'); logo.className='task-logo'; logo.textContent='üéÅ';
    const main=document.createElement('div'); main.className='task-main';
    const t=document.createElement('div'); t.className='task-title'; t.textContent=it.title;
    const s=document.createElement('div'); s.className='task-reward'; s.textContent=new Date(it.ts).toLocaleString();
    main.appendChild(t); main.appendChild(s);
    card.appendChild(logo); card.appendChild(main);
    g.appendChild(card);
  });
}
renderInv();

/* ========= SPIN ACTION ========= */
let spinning=false;
spinBtn.addEventListener('click', ()=>{
  if(spinning) return;
  const payTon = payTonSwitch.classList.contains('on');
  if(payTon){
    // –°–ø–∏—Å–∞–Ω–∏–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞
    const needTon = TON_PRICE_BY_STARS[selectedStars] || 0;
    const bal = readBalance();
    if(bal + 1e-9 < needTon){ showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ TON –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º –±–∞–ª–∞–Ω—Å–µ'); return; }
    writeBalance(bal - needTon);
    addHistory({ type:'purchase', amount: needTon, payWith:'ton', date: Date.now() });
    startSpinFlow();
  }else{
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º Stars invoice
    Telegram.WebApp.openInvoice(selectedInvoice);
  }
});
Telegram.WebApp.onEvent('invoiceClosed', (ev)=>{
  if(ev.status === 'paid'){ addHistory({ type:'purchase', amount: selectedStars, payWith:'stars', date: Date.now() }); startSpinFlow(); }
});
function startSpinFlow(){
  spinning=true;
  const prize = "IMG_3621.JPEG"; // –¥–µ–º–æ
  const idx = fullGifts.findIndex(v=>v===prize) + 5 * (gifts.length);
  const offset = idx * 120 - (document.getElementById("reel").offsetWidth / 2 - 60);
  gsap.to(giftsTrack,{
    x:-offset, duration:6, ease:"power5.inOut",
    onComplete(){
      openResult(false);
      addInvItem(`Roulette ${selectedStars}‚òÖ`);
      spinning=false;
    }
  });
}

/* ========= TASKS ========= */
const tasks = [
  { id:'t1', title:'–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –Ω–∞—à –∫–∞–Ω–∞–ª', url:'https://t.me/voco_in', reward:'+10% —à–∞–Ω—Å' },
  { id:'t2', title:'–û—Ç–∫—Ä–æ–π—Ç–µ –ú–∞—Ä–∫–µ—Ç', url:'https://t.me/portals/market?startapp=wfu2s0', reward:'+10% —à–∞–Ω—Å' },
  { id:'t3', title:'–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∫–∞–Ω–∞–ª', url:'https://t.me/vo2co', reward:'+10% —à–∞–Ω—Å' },
];
let tasksState = JSON.parse(localStorage.getItem(TASKS_STATE_KEY)||'{}');
let lastOpenTaskId = null;

function renderTasks(){
  const list = $('#tasksList'); list.innerHTML='';
  tasks.forEach(t=>{
    const item=document.createElement('div'); item.className='task-item';
    const logo=document.createElement('div'); logo.className='task-logo'; logo.textContent='‚úàÔ∏è';
    const main=document.createElement('div'); main.className='task-main';
    const title=document.createElement('div'); title.className='task-title'; title.textContent=t.title;
    const rew=document.createElement('div'); rew.className='task-reward'; rew.textContent=t.reward;
    main.appendChild(title); main.appendChild(rew);
    const action=document.createElement('div'); action.className='task-action';
    if(tasksState[t.id]?.done){
      const badge=document.createElement('div'); badge.className='badge-done'; badge.textContent='–ü–æ–ª—É—á–µ–Ω–æ ‚úì'; action.appendChild(badge);
    }else{
      const btn=document.createElement('button'); btn.className='btn-start'; btn.textContent='–ù–∞—á–∞—Ç—å';
      btn.addEventListener('click', ()=>{ lastOpenTaskId=t.id; openLink(t.url); });
      action.appendChild(btn);
    }
    item.appendChild(logo); item.appendChild(main); item.appendChild(action);
    list.appendChild(item);
  });
}
renderTasks();

/* –û—Ç–º–µ—á–∞–µ–º –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ */
document.addEventListener('visibilitychange', ()=>{
  if(document.visibilityState==='visible' && lastOpenTaskId){
    tasksState[lastOpenTaskId] = { done:true, ts:Date.now() };
    localStorage.setItem(TASKS_STATE_KEY, JSON.stringify(tasksState));
    lastOpenTaskId=null; renderTasks(); showToast('–ó–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ ‚úÖ');
  }
});

/* ========= INIT ========= */
updateSpinButtonLabel();
</script>
</body>
</html>

